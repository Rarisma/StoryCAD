name: Resolve Package.appxmanifest Conflicts

on:
  pull_request_target:
    paths:
      - 'StoryCAD/Package.appxmanifest'
    types: [opened, synchronize, reopened]

jobs:
  resolve-conflicts:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0 # This ensures all commits/history are fetched.

      - name: Check for conflicted Package.appxmanifest
        id: check_conflicted
        run: |
          cd "${{ github.workspace }}"
          $isConflicted = (git diff --name-only --diff-filter=U | Select-String -Pattern "StoryCAD/Package.appxmanifest" -Quiet)
          echo "Is Conflicted: $isConflicted"
          if ($isConflicted) {
            echo "is_conflicted=True" >> $GITHUB_ENV # Use environment file instead of deprecated set-output.
          } else {
            echo "is_conflicted=False" >> $GITHUB_ENV
          }

      - name: Resolve conflicts if any
        if: env.is_conflicted == 'True'
        run: |
          cd "${{ github.workspace }}"
          git config --global user.name 'Automated Conflict Resolver'
          git config --global user.email 'actions@github.com'
          git checkout --theirs -- 'StoryCAD/Package.appxmanifest'
          git add 'StoryCAD/Package.appxmanifest'
          git commit -m "Resolved conflicts in Package.appxmanifest"

      - name: Notify conflict resolution status
        run: |
          if ($env:is_conflicted -eq 'True') {
            echo "Conflicts found and resolved."
          } else {
            echo "No conflicts found in Package.appxmanifest."
          }
